; Standard Adventure Asource
;
; M.J.Austin 13/9/85
;
; Parser
;
VAR
 CSAVEHISEARCHPOS EVENTUALPREP

BEGIN
.CANCELINPUT
; something of great importance has happened - remove
; rest of input from line
 GOSUB @ABSCANCELINPUT
.GETCOMMAND
 GOSUB @TICKCLOCK
.GC0
 STACK
.GC1
 PROCESSINGSAY=FALSE
 SAYRESPONSE=FALSE
; before printing What now?, check if any more commands waiting
 IF NOMOREINPUT=FALSE THEN GC3 ; still something left on line
 NOMOREINPUT=FALSE ; disable flag which is set on getting 0 from input
 IF SOMETHINGPROCESSED=FALSE THEN GC3 ; prevent CR producing 'WHAT NOW'
.WHATNOW
 MESSAGE 17 ; WHAT NOW ?%
 RANDOM X1 ; kick random number generator
 SOMETHINGPROCESSED=FALSE
 IF TALKINGTONPC=FALSE THEN @GC2A
 PLAYER=USER ; was controlling an NPC, now reset it
 TALKINGTONPC=FALSE
 GOSUB @SETUPROOM

 GOSUB @SETUPDOOR
.GC2A
 GOSUB @SETUPROOM ;?? really necessary ?
.GC3
 GOSUB @PARSEINPUT
 IF VERB<>0 THEN GC4
 GOTO GC0

.GC4
 GOSUB @PRECOMMAND
 GOSUB PRESENTMULTIPLE ; HANDLE MULTIPLE OBJECTS, CALLING VERB REPEATEDLY
 GOTO @POSTCOMMAND
;---
.PRESENTMULTIPLE
; GIVEN VERB,PREP,NOUN2 AND OBJECTTABLE,
; CQLL VERB ONCE FOB EACH OBJECT SPUCIFIED BY OBJECDTABLE
; EVERYTXING, IT ETC. ARE HANDLED HERE
; Work down from top so static orjects, containebs come first
 SAYRESPONSE=TRUE
 MESSAGE CR
 DIR=0 ;  prevent some SPECIALMOVES being triggered
 GOSUB @CONVERTVERB
 AGAINVERB=VERB
 GOSUB @SELECTOBJECTPOS
;
; ??? as a kludge - test here to see if NOUN2 is present
 IF NOUNEXT
 ADD CURRENTOBJECT,C1
 GOTO PMSINGLE1

.PMSINGLEEND
 IF HAVECALLEDVERB=TRUE THEN PMSINGLERET
 NOUN1=NULLOBJECT
 GOSUB CALLVERB

.PMSINGLERET
 RETURN
;---
.PMEVERYTHING
 CURRENTOBJECT=MAXOBJECTVISIBLE
 NOUN1=NULLOBJECT
.PMEV1
;
; check if object if forbidden
;
 OBJECT=CURRENTOBJECT

 GOSUB @CHECKIFACCESSIBLE
 IF RESULT=FALSE THEN PMEV3

 SEARCHDEPTH=1
 X1=CURRENTPOS(OBJECT)
 IF X1<>PLAYER THEN PMEV2
 X1=HICURRENTPOS(OBJECT)
 IF X1<>0 THEN PMEV2A ; player's contents always obviEXT
 ADD CURRENTOBJECT,C1
 GOTO PMSINGLE1

.PMSINGLEEND
 IF HAVECALLEDVERB=TRUE THEN PMSINGLERET
 NOUN1=NULLOBJECT
 GOSUB CALLVERB

.PMSINGLERET
 RETURN
;---
.PMEVERYTHING
 CURRENTOBJECT=MAXOBJECTVISIBLE
 NOUN1=NULLOBJECT
.PMEV1
;
; check if object if forbidden
;
 OBJECT=CURRENTOBJECT

 GOSUB @CHECKIFACCESSIBLE
 IF RESULT=FALSE THEN PMEV3

 SEARCHDEPTH=1
 X1=CURRENTPOS(OBJECT)
 IF X1<>PLAYER THEN PMEV2
 X1=HICURRENTPOS(OBJECT)
 IF X1<>0 THEN PMEV2A ; player's contents always obvious in this context
.PMEV2
 GOSUB @CHECKIFOBVIOUS
 IF OBVIOUS=FALSE THEN PMEV3
.PMEV2A

 GOSUB @CHECKIFFORBIDDEN
 IF RESULT=TRUE THEN PMEV3

 NOUN1=CURRENTOBJECT
 HAVECALLEDVERB=TRUE
 GOSUB CALLVERB
 MESSAGE CR ;??
.PMEV3
 SUB CURRENTOBJECT,C1
 IF CURRENTOBJECT<NEGATIVE THEN PMEV1
 IF HAVECALLEDVERB=TRUE THEN PMRET
 GOSUB CALLVERB

.PMRET
 RETURN

;---
.CALLVERB
; GIVEN VERB,PREP,NOUN1,NOUN2,
; DO THE JUMP-TABLE INDEXING ON THE VERB
; MESSAGE CR
 CSAVEHISEARCHpos=HISEARCHPOS

 IF NOUN1=NULLOBJECT THEN CALLVERBNODESC
 IF EVERYTHING=TRUE THEN CALLVERBDESC
 IF VERBSTOCALL<2 THEN CALLVERBNODESC
.CALLVERBDESC
 IF TALKINGTONPC=TRUE THEN CALLVERBNODESC
 X1=NOUN1
 GOSUB @DESCOBJX1
 MESSAGE COLON

.CALLVERBNODESC
 LASTWORDPRINTED=NOUN1
 GOSUB ABSCALLVERB

 HISEARCHPOS=CSAVEHISEARCHpos
 RETURN
;---
.ABSCALLVERB
 if verb=101 then @cheat

; Come here to call verb without printing desc first
 LASTVERBVALID=TRUE
 OBJECT=NOUN1
 HISEARCHPOS=NONSPECIFIC
 RESULT=TRUE
 GOSUB @FUNNIES
 IF RESULT=TRUE THEN CVRET
 OBJECT=NOUN2
 GOSUB @OBJECTTRIGGER
 IF RESULT=TRUE THEN CVRET
 OBJECT=NOUN1
 GOSUB @OBJECTTRIGGER ; TRIGGERS FOR ANY VERB ON OBJECT
 IF RESULT=TRUE THEN CVRET ; FLAG NOT RESET, SO COMMAND PROCESSED

; Do jump-table type indexing
; Flow will return to PRESENTMULTIPLE when the verb has finished

 IF TALKINGTONPC=TRUE THEN ACVNOTESP
 IF ESPROOM=0 THEN ACVNOTESP ; ** SPECIAL TO MAGIK
; valid verbs when ESP is active
 IF VERB=ICAST THEN @CAST
 IF VERB=IEXAMINE THEN @EXAMINE
 IF VERB=ILOOK THEN @DESCRIBEROOM
 IF VERB=IWAIT THEN @WAIT
 MESSAGE 3322 ; you're only a projection - remember ?
.CVRET
 RETURN

.ACVNOTESP
 IF VERB=ICLIMB THEN @CLIMB
 IF VERB=IJUMP THEN @JUMP
 IF VERB<16 THEN @MOVE
 IF VERB=IFEAR THEN @FEAR
 IF VERB=22 THEN @INVENTORY
 IF VERB=IRESTORE THEN @RESTORE
 IF VERB=ISAVE THEN @SAVE
 IF VERB=IRAMSAVE THEN @RAMSAVE
 IF VERB=IRAMLOAD THEN @RAMLOAD
 IF VERB=IOOPS THEN @OOPS
 IF VERB=IQUIT THEN @QUIT
 IF VERB=ILOOK THEN @DESCRIBEROOM
; IF VERB=ILISTEN THEN @HEAR
; IF VERB=ISMELL THEN @SMELL
 IF VERB=IWAIT THEN @WAIT
;; IF VERB=ISLEEP THEN @SLEEP
 IF VERB=IVHELLO THEN @HELLO
 IF VERB=IKNOCK THEN @KNOCK

 IF VERB=IPICTURE THEN @PICTURE
 IF VERB=IWORDS THEN @WORDS
 IF VERB=ISTAND THEN @STAND
 IF VERB=ILIE THEN @LIE
 IF VERB=ISIT THEN @SIT
 IF VERB=ISCORE THEN @SCORE
 IF VERB=IVERBOSE THEN @VERBOSE
 IF VERB=IBRIEF THEN @BRIEF
 if verb=31 then @Exits
 IF VERB=IDIG THEN @DIG
 IF VERB=IFILL THEN @FILL

 IF VERB=IHELP THEN @HELP
 IF VERB=IVYES THEN @YES
 IF VERB=IVNO THEN @NO
 IF VERB=IVWHY THEN @WHY
 IF VERB=IBOARD THEN @BOARD

 IF VERB=IPUT THEN @PUT
 IF VERB=IPLAY THEN @PLAY
 IF VERB=IEXTINGUISH THEN @EXTINGUISH

 IF NOUN1<>NULLOBJECT THEN @CVGOTNOUN
 IF TALKINGTONPC=TRUE THEN @NPCNOTUNDERSTOOD
; .MUSTSUPPLYOBJECT
 M1=2033 ; must supply an object group
 GOTO @VARYMESSAGE

.CVGOTNOUN
 IF VERB<41 THEN @TOOCOMPLEX
 IF VERB=IOPEN THEN @OPEN
 IF VERB=ITAKE THEN @TAKE
 IF VERB=IPICK THEN @TAKE
 IF VERB=IWEAR THEN @WEAR
 IF VERB=IDROP THEN @DROP
 IF VERB=IEXAMINE THEN @EXAMINE
 IF VERB=IATTACK THEN @ATTACK
 IF VERB=ICUT THEN @CUT
 IF VERB=IREMOVE THEN @REMOVE
 IF VERB=ITHROW THEN @THROW
 IF VERB=IEAT THEN @EAT
 IF VERB=IDRINK THEN @DRINK
 IF VERB=IPUSH THEN @PUSH
 IF VERB=IPULL THEN @PULL
 IF VERB=IRING THEN @VRING
 IF VERB=IGIVE THEN @GIVE
 IF VERB=IWAKE THEN @WAKE
 IF VERB=IBURY THEN @BURY
 IF VERB=ISQUEEZE THEN @SQUEEZE
 IF VERB=IDRESS THEN @DRESS
 IF VERB=ICAST THEN @CAST
 IF VERB=IFASTEN THEN @FASTEN
 IF VERB=IRUB THEN @RUB
 IF VERB=ILIGHT THEN @LIGHT
 MESSAGE 2036 ; don't unterstand verb
 RETURN
;---
.TOOCOMPLEX
 MESSAGE 2039 ; sentence is too complex
 RETURN
;---
.CHECKIFACCESSIBLE
;0return RESULT=TBUE if OBJECT is0accessible to VERB
; objects must be present in way HISEARCHPOS
 if verb<>101 then CIANotCheat
 if object=4 then @returntrue
 if object=260 then @returntrue
 if object=261 then @returntrue

.ciaNotCheat
 IF VERB<>ICAST THEN CIANCAST
 IF NOUN1=SPYSPELLOFFSETTHEN @CHECKIFSCENERYHERE
 IF HISEARCHPOS<>NONSPECIFIC THEN CIANOTNS
 POS=ROOM
 HIPOS=0
 GOSUB @CHECKOBJECTPOS
 IF RESULT=TRUE THEN CIAHAVECHECKED
 GOTO CIAISITOWNED

.CIANOTNS
 IF HISEARCHPOS<>NOUNCARRIED THEN CIANOTCARRIED
.CIAISITOWNED
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS
 GOTO CIAHAVECHECKED

.CIANOTCARRIED
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS ; looking on ground only. if carried, can't be
 X1=RESULT
 RESULT=FALSE
 IF X1=TRUE THEN CIAHAVECHECKED
 PTHEN @CHECKIFSCENERYHERE
 IF HISEARCHPOS<>NONSPECIFIC THEN CIANOTNS
 POS=ROOM
 HIPOS=0
 GOSUB @CHECKOBJECTPOS
 IF RESULT=TRUE THEN CIAHAVECHECKED
 GOTO CIAISITOWNED

.CIANOTNS
 IF HISEARCHPOS<>NOUNCARRIED THEN CIANOTCARRIED
.CIAISITOWNED
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS
 GOTO CIAHAVECHECKED

.CIANOTCARRIED
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS ; looking on ground only. if carried, can't be
 X1=RESULT
 RESULT=FALSE
 IF X1=TRUE THEN CIAHAVECHECKED
 POS=ROOM
 HIPOS=0
 GOSUB @CHECKOBJECTPOS

.CIAHAVECHECKED
 RETURN
;---
.PRINTINPUTWORD
 MESSAGE QUOTE
 PRINTINPUT
 MESSAGE QUOTE
 RETURN
;---
.PARSETOOMUCH ; TOO MUCH ENTERED
 M1=2001
 GOTO PARSEERROR
;---
.PARSENOOBJECT
 M1=2002
 GOTO PARSEERROR
;---
.PARSENOTKNOWN
; word not recognized at all
 IF TALKINGTONPC=TRUE THEN NPCNOTUNDERSTOOD
 MESSAGE 2005 ; I don't know the word
 GOSUB PRINTINPUTWORD
 MESSAGE DOT
 GOTO @CANCELINPUT
;---
.PARSENOVERB
 IF PROCESSINGSAY=TRUE THEN @SAYNPCLOOP ; no verb, so continue scanning
.SECONDPREP
.CANTUSEHERE
 IF TALKINGTONPC=TRUE THEN NPCNOTUNDERSTOOD
 MESSAGE 2003
 GOSUB PRINTINPUTWORD
 M1=2004
 GOTO PARSEERROR
;---
.NPCLOOKSFORSOMETHING
 GOSUB @ISNPCVISIBLE
 IF RESULT=FALSE THEN NPCLFSRET
 X1=PLAYER
 GOSUB @DESCTHEOBJX1
 MESSAGE 2065 ; looks around as if looking for something
.NPCLFSRET
 RETURN
;---
.NPCNOTUNDERSTOOD
; an NPC (variable PLAYER) is trying to do something which it can't
 GOSUB @ISNPCVISIBLE
 IF RESULT=FALSE THEN NPCLFSRET
 IF PLAYER<>ANTS THEN NNU1
 MESSAGE 3860 ; ants wave mandibles
 GOTO @CANCELINPUT

.NNU1
 X1=PLAYER
 GOSUB @DESCTHEOBJX1
 M1=2062 ; looks puzzled
 GOSUB @VARYMESSAGE
 GOTO @CANCELINPUT
;---
.NOTCLEAR
; User has referred to a piece of scenery which is not nearby
 IF TALKINGTONPC=TRUE THEN NPCNOTUNDERSTOOD
 OBJECT=0
 HAVECALLEDVERB=TRUE
 ADD VERBSTOCALL,C1
 PRINTINPUT
 MESSAGE COLON
 MESSAGE 2130 ; not clear
.NCRET
 RETURN
;---
.DONTUNDERSTAND
; general error message when the parsing has borken
; down for some reason
 M1=2010
; drop through to PARSEERROR
;-
.PARSEERROR
 IF TALKINGTONPC=TRUE THEN NPCNOTUNDERSTOOD
 MESSAGE M1
 MESSAGE DOTCR
 GOTO @CANCELINPUT
;---
.OBJECTNOTHERE
; THE OBJECT IS NOT AVAILBALE TO THE COMMAND
; THIS ERROR RETURNS AS IT IS USED IN PRESENTMULTIPLE
 IF OBJECT=0 THEN ONTRET
 IF TALKINGTONPC=TRUE THEN NPCLOOKSFORSOMETHING
 IF HISEARCHPOS=NOUNONGROUND THEN ONT1
 IF HISEARCHPOS=NONSPECIFIC THEN CANTSEEIT
 MESSAGE 2012 ; don't have..
.ONTERROR
; MESSAGE 21 ; THE
 X1=OBJECT
 GOSUB @DESCTHEOBJX1
 MESSAGE DOT
 GOTO @CANCELINPUT

.ONT1
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS
 IF RESULT=TRUE THEN ONT2
.CANTSEEIT
 IF OBJECT=IEVERYTHING THEN @CANTUSEHERE ; EVERYTHING as NOUN2
 POS=PLAYER
 HIPOS=NONSPECIFIC
 GOSUB @CHECKOBJECTPOS
 IF RESULT=TRUE THEN ONT2
.GENCANTSEEIT
 MESSAGE 2011 ; Can't see ..
 GOTO ONTERROR
.ONT2
 IF VERB=ISTAND THEN ONTDROPFIRST
 MESSAGE 2013 ; Already have ..
 GOTO ONTERROR

.ONTDROPFIRST
 MESSAGE 2126 ; have to drop it first
.ONTRET
 RETURN
;----
.ITSNOTTHERE
; user asked for NOUN1 in NOUN2 or similar
; but NOUN1 is not contained by NOUN2
 MESSAGE 2017 ; it's not there
 RETURN
;---
.PARSEINPUT
; CONVERT INPUT TO VERB, PREP, OBJECT FORM FOR
; EASY UNDERSTANDING BY THE REST OF THE PROGRAM
 HAVECALLEDVERB=FALSE
 GOSUB @GETNEXTWORD
 VERB=0
 IF EOL=TRUE THEN @PIEND; NOTHING ENTERED !
;
; is player trying to talk to someone ?
 SEARCHTYPE=NOUNTYPE
 GOSUB @CHECKTYPE
 IF VALUE<NPCBASE THEN PINOTNPC
 IF VALUE>NPCMAX THEN PINOTNPC
; yes, so is the target here ?
 OBJECT=VALUE
 GOSUB @CHECKIFPRESENT
 IF RESULT=TRUE THEN PINPC
 MESSAGE 2060 ; talking to yourself ?
 GOTO @ABSCANCELINPUT

.CANTTALKTOSEVERAL
; can't talk to more dhan one person
 MESSAGE 2061
 GOTO @ABSCANCELINPUT
.PINPC
; sed up conversatio~ target as player
 IF PLAYER=VALUE THEN PINPC1
 IF TALKINGTONPC=TRUE THEN CANTTALKTOSEVERAL
.PINPC1
 PLAYER=VALUE
 TALKINGTONPC=TRUE
 GOSUB @SETUPROOM
 gosub @SetUpDoor ;>>Mike 21/2/88
;??? GOSUB GETNEXTWORD ; firsd word of what's0said
 GOTO @SAYNPC

.PINOTNPC
 SEARCHTYPE=VERBTYPE
 GOSUB @CHECKTYPE
 IF VALUE<>0 THEN PI0

 SEARCHTYPE=NOUNTYPE
 GOSUB @CHECKTYPE
 IF VALUE>IGARBAGE THEN PARSEINPUT ; CONJUNCTION ENTERED, SO TRY AGAIN

 GOTO @PARSENOVERB ; Wrong type of word found
.PI0
 IF VALUE<>IAGAIN THEN PI0A
 VERB=AGAINVERB
 IF LASTVERBVALID=TRUE THEN @PIEND
.LASTVERBINVALID
 IF TALKINGTONPC=TRUE THEN @NPCNOTUNDERSTOOD
 M1=2050 ; last verb nINK
 IF VERB<ICROSS THEN PIEND

; VERB MAY BE FOLLOWED BY SOMETHING ELSE
 GOSUB @SELECTOBJECTPOS

.PINEXT
.PIANOTHERNOUN
 IF VERB=ISAY THEN @SAY
 IF VERB=IASK THEN @ASK
 GOSUB @GETNEXTWORD

 IF SEPARATOR=TRUE THEN PINEXT
 IF EOL=TRUE THEN PIEND
.PINEXT1

 IF VERB=IDROP THEN PINOTPREP ; DROP BENCH AND ON
 IF VERB=IOPEN THEN PINOTPREP ; OPEN DOOR AND IN

 SEARCHTYPE=PREPTYPE
 GOSUB @CHECKTYPE
 IF VALUE<>0 THEN PIPREP

.PINOTPREP
;?? OBJECT=VALUE
 GOSUB @CHECKNOUN
 IF OBJECT<>0 THEN PINK
 IF VERB<ICROSS THEN PIEND

; VERB MAY BE FOLLOWED BY SOMETHING ELSE
 GOSUB @SELECTOBJECTPOS

.PINEXT
.PIANOTHERNOUN
 IF VERB=ISAY THEN @SAY
 IF VERB=IASK THEN @ASK
 GOSUB @GETNEXTWORD

 IF SEPARATOR=TRUE THEN PINEXT
 IF EOL=TRUE THEN PIEND
.PINEXT1

 IF VERB=IDROP THEN PINOTPREP ; DROP BENCH AND ON
 IF VERB=IOPEN THEN PINOTPREP ; OPEN DOOR AND IN

 SEARCHTYPE=PREPTYPE
 GOSUB @CHECKTYPE
 IF VALUE<>0 THEN PIPREP

.PINOTPREP
;?? OBJECT=VALUE
 GOSUB @CHECKNOUN
 IF OBJECT<>0 THEN PIEXAMINENOUN
 IF PROCESSED=TRUE THEN PINEXT

 SEARCHTYPE=ASCITYPE
 GOSUB @CHECKTYPE
 IF VALUE=ICOMMA THEN PINEXT
 IF VALUE<>0 THEN PINEXT

 SEARCHTYPE=NUMBTYPE
 GOSUB @CHECKTYPE
 IF VALUE=0 THEN PINOTNUMBER
 INUMBER=VALUE
 ITNUMBER=INUMBER
; OBJECT=BUTTONS
 ADD VERBSTOCALL,C1
 GOTO PINEXT

.PINOTNUMBER
; ANYTHING ELSE (CONJ, VERBS ETC.) TERMINATE THIS SENTENCE
 GOSUB @GOBACK ; STORE (VERB?) FOR FUTURE ANALYSIS

.PIEND
 IF EVENTUALPREP=0 THEN PIRET
 PREP=EVENTUALPREP
.PIRET
 RETURN
 
.PIPREP
 IF PREP<>0 THEN @SECONDPREP ; GOT A SECOND PREP
 PREP=VALUE
 GOSUB @CONVERTVERB
 GOSUB @SELECTOBJECTPOS
 GOTO PINEXT

.PIEXAMINENOUN
 IF OBJECT<>IIT THEN PINOTIT
 OBJECT=ITWORD
 INUMBER=ITNUMBER
 IF OBJECT<NULLOBJECT THEN PINOTIT
 IF TALKINGTONPC=TRUE THEN @NPCNOTUNDERSTOOD
 MESSAGE 2053 ; it's not clear what IT refers to here
 GOTO @CANCELINPUT

.PINOTIT
 IF PREP<>0 THEN @PINOUN2
 IF OBJECT=IEVERYTHING THEN PIEVERYTHING
 IF OBJECT=IEXCEPT THEN @PIEXCEPT
; GOT AN ORDINARY NOUN SPECIFIED
 ITWORD=OBJECT
 ITNUMBER=NULLNUMBER
 IF OBJECT<NUMBEROFFSET THEN PION0
 IF OBJECT>HINUMBEROFFSET THEN PION0
 GOTO @PINEXT
;
.PION0
; IF OBJECT<SPELLBASE THEN PION1
; IF OBJECT>SPELLMAXPLUSONE THEN PION1
; SPELL=OBJECT
; GOTO PINEXT

.PION1
; hold on a moment. There are certain constructs where
; the first noun can be the destination
; e.g. "GIVE ME THE MANDRAKE"
 IF VERB<>IGIVE THEN PION2
 IF TALKINGTONPC=FALSE THEN PION2
 IF OBJECT=USER THEN PIGIVE
; IF OBJECT>NPCMAX THEN PION2
; IF OBJECT>NPCBASE THEN PIGIVE

.PION2
 X1=NOUNFORBIDDEN ; mark noun as forbidden
 IF EXCEPT=TRUE THEN PIMARK ; DON'T CHECK IT'S HERE (YET)
; mark ordinary noun
 X1=NOUNSPECIFIED
.PIMARK
 NOUN1=OBJECT
 GOSUB MARKOBJECT ; MARK NOUN AS SPECIFICALLY REQUESTED
 GOTO @PINEXT
;
.PIEVERYTHING
 EVERYTHING=TRUE
 NOUN1=EVERYTHING ;???
 GOTO @PINEXT

.PIGIVE
 IF PREP<>0 THEN @DONTUNDERSTAND
 NOUN2=OBJECT
 EVENTUALPREP=ITO
 GOTO @PINEXT
;---
.STRIPX1
; STRIP OFF TOP TWO BITS OF X1.
 IF X1<64 THEN STRIPX1RET
 X2=64
 SUB X1,X2
 GOTO STRIPX1
.STRIPX1RET
 RETURN
;---
.CHECKIFSCENERYHERE
; given OBJECT as a noun requested by user (relative to NOUNOFFSET)
; see if it is part of a room description, and
; if so, return RESULT=TRUE if in current room
 X1=NOUNOFFSET
 ADD X1,OBJECT
 IF X1>1999 THEN RETURNTRUE ; >2000, so a random output message
 X2=SHORTROOMDESCS
 SUB X1,X2
 IF X1=ROOM THEN RETURNTRUE
 X2=300 ; LONGROOMDESCS-SHORTROOMDESCS
 SUB X1,X2
 IF X1<>ROOM THEN RETURNFALSE
; drop through to return TRUE
.RETURNTRUE
 RESULT=TRUE
 RETURN
.RETURNFALSE
 RESULT=FALSE
 RETURN
;---
.MARKOBJECT
; mark object as X1
 X2=OBJECTTABLE(C0)
 IF X2=0 THEN MARKOBJ1
 IF X1<>X2 THEN @DONTUNDERSTAND ; have had both mark and prevent types
.MARKOBJ1
 X2=1
.MARKOBJ2
 X3=OBJECTTABLE(X2)
 IF X3=OBJECT THEN MARKOBJRET ; already marked
 IF X3=0 THEN MARKOBJ3
 ADD X2,C1
 GOTO MARKOBJ2

.MARKOBJ3
 IF X2>15 THEN @DONTUNDERSTAND  ; OBJECTTABLE OVERFLOW
 ADD VERBSTOCALL,C1
 OBJECTTABLE(C0)=X1
 OBJECTTABLE(X2)=OBJECT
 ADD X2,C1
 OBJECTTABLE(X2)=C0
.MARKOBJRET
 RETURN
;---
.CHECKIFFORBIDDEN
 RESULT=FALSE
 X1=OBJECTTABLE(C0)
 IF X1<>NOUNFORBIDDEN THEN CIFRET
 X2=1
.CIF1
 X1=OBJECTTABLE(X2)
 ADD X2,C1 ;???C9
 IF X1=0 THEN CIFRET
 IF X1<>OBJECT THEN CIF1
 RESULT=TRUE
.CIFRET
 RETURN
;---
.SCENERY
; Have got a noun which is in a room description or similar,
; so it is just scenery. Print an appropriate message.
 IF TALKINGTONPC=TRUE THEN @NPCNOTUNDERSTOOD
 ITWORD=NULLOBJECT
 HAVECALLEDVERB=TRUE
 PRINTINPUT
 MESSAGE COLON

 GOSUB @FUNNIES ; Print out any special messages
 OBJECT=0
 IF RESULT=TRUE THEN SCENERYEND

 M1=2030 ; just scenery group
 GOSUB @VARYMESSAGE
.SCENERYEND
.SCENERYRET
 RETURN
;---

.PIEXCEPT
 EXCEPT=TRUE
 GOTO @PINEXT

.PINOUN2
; another noun in input, not part of any multiple noun
 IF NOUN2=NULLOBJECT THEN PINOUN2A
 IF NOUN2<>OBJECT THEN @DONTUNDERSTAND
.PINOUN2A
 NOUN2=OBJECT
 GOTO @PINEXT
;---

.CHECKTYPE
; SEE IF THERE CKTYPERET
;>>mike 16/2/88 IF VALUE>EXAMINEMAXOFFSET THEN CHECKTYPERET
;>>mike 16/2/88; an examine message
;>>mike 16/2/88 X1=EXAMINEOFFSET
;>>mike 16/2/88 SUB VALUE,X1

.CHECKTYPERET
 RETURN
;---
.CHECKNOUN
; see if there is an object present
; finding possible alternatives. Return RESULT=TRUE if found
 if verb<>101 then checkNounNotCheat
 if object=260 then @checknnormal
 if object=261 then @checknnormal

.CheckNounNotCheat
 PROCESSED=TRUE
 SEARCHTYPE=ADJETYPE
 GOSUB CHECKTYPE
 IF VALUECKTYPERET
;>>mike 16/2/88 IF VALUE>EXAMINEMAXOFFSET THEN CHECKTYPERET
;>>mike 16/2/88; an examine message
;>>mike 16/2/88 X1=EXAMINEOFFSET
;>>mike 16/2/88 SUB VALUE,X1

.CHECKTYPERET
 RETURN
;---
.CHECKNOUN
; see if there is an object present
; finding possible alternatives. Return RESULT=TRUE if found
 if verb<>101 then checkNounNotCheat
 if object=260 then @checknnormal
 if object=261 then @checknnormal

.CheckNounNotCheat
 PROCESSED=TRUE
 SEARCHTYPE=ADJETYPE
 GOSUB CHECKTYPE
 IF VALUE=0 THEN CNNOTADJE
 ADJECTIVE1=VALUE
 GOSUB CHECKTYPEMORE
 IF VALUE=0 THEN CNADJEND
 ADJECTIVE2=VALUE
.CNADJEND
 OBJECT=0
 RETURN

.CNNOTADJE
 SEARCHTYPE=NOUNTYPE
 GOSUB CHECKTYPE
 OBJECT=0
 IF PREP=0 THEN CHECKNOUN0
 HISEARCHPOS=NONSPECIFIC
.CHECKNOUN0
 IF VALUE>IGARBAGE THEN CNGARBAGE
 IF VALUE>3599 THEN CNNOTCLEAR ; a saying or garbage word
; have a possible valid object.
; does it match with any adjective requested ?
 IF ADJECTIVE1=NULLOBJECT THEN CHECKNOUN1
 IF VALUE=ADJECTIVE1 THEN CHECKNOUN1
 IF VALUE<>ADJECTIVE2 THEN CNMORE ; no, so try another
.CHECKNOUN1
; is it here ?
 OBJECT=VALUE
 GOSUB @CHECKIFACCESSIBLE
 IF RESULT=TRUE THEN CHECKNOUNEND ; if present, accept as is

.CNMORE
; not present, so look for another match
 GOSUB @CHECKTYPEMORE
 IF VALUE<>0 THEN CHECKNOUN0

.CNNOTCLEAR
; no noun found which is present
 IF OBJECT=0 THEN CHECKNNORMAL ; not a noun at all
; so print appropriate message
 IF OBJECT>MAXOBJECT THEN CNNOTCLEAR1
 GOSUB @OBJECTNOTHERE
 HAVECALLEDVERB=TRUE
.CNGARBAGE
 RESULT=FALSE
 OBJECT=0
 RETURN

.CNNOTCLEAR1
; OBJECT>MAXOBJECT, see if it is valid
 IF OBJECT=IEVERYTHING THEN CHECKNNORMAL
 IF OBJECT=IIT THEN CHECKNNORMAL
 IF OBJECT=IEXCEPT THEN CHECKNNORMAL
 GOTO @NOTCLEAR

.CHECKNOUNEND
 IF OBJECT<OMNIBASE THEN CNNOMNI
 IF OBJECT>OMNIMAX THEN CNNOMNI
 GOTO CHECKNNORMAL

.CNNOMNI
 IF OBJECT>MAXOBJECT THEN @SCENERY
.CHECKNNORMAL
 PROCESSED=FALSE
 RETURN
;---
.ABSCANCELINPUT
; called after any errors - remove rest of input from line
 INDEX=0
 GOSUB @READINPUTLIST
 LINPUT(C0)=C0 ; in case NOMOREINPUT=TRUE, and LIST9<>0
 LINPUT(C1)=C0
 IF VALUE=0 THEN CLEARINPEND
 SUPRESSCHECKING=TRUE ; don't check words for validity
 GOSUB GETNEXTWORD
 GOTO ABSCANCELINPUT
.CLEARINPEND
 SUPRESSCHECKING=FALSE
 RETURN
;---
.GETNEXTWORD
; GET NEXT WORD IN LINPUT
; set EOL=TRUE if get ".", eol, etc.
; Set SEPARATOR=TRUE if get "." ","
 IF NOMOREINPUT=TRUE THEN GNWEND
 IF WORDNOTPROCESSED=TRUE THEN GNWEND ; HAVE USED GOBACK TO RETRIEVE
 INPUT X1 X1 X1 X1
 SEARCHTYPE=ASCITYPE
 GOSUB @CHECKTYPE
 IF VALUE<33 THEN GNW1
 IF VALUE<38 THEN @GETNEXTWORD
.GNW1
 GOSUB CHECKEOL ; CHECK FOR "." "THEN" etc.
 IF PROCESSINGSAY=FALSE THEN GNWEND
 GOSUB @TRIGGERWORDS ; in SAY command, so look for key words

.GNWEND
 WORDNOTPROCESSED=FALSE
.CIGRET
 RETURN
;---
.CHECKEOL
 INDEX=0
 GOSUB READINPUTLIST
 SEPARATOR=FALSE
 EOL=FALSE
 IF VALUE=0 THEN SETNOTHINGMORE
 SEARCHTYPE=CONJTYPE
 GOSUB @CHECKTYPE
 IF VALUE=ITHEN THEN SETEOL
 SEARCHTYPE=ASCITYPE
 GOSUB @CHECKTYPE
 IF SUPRESSCHECKING=TRUE THEN CHECKEOL1
 IF VALUE=128 THEN @PARSENOTKNOWN ; WORD NOT UNDERSTOOD
.CHECKEOL1
 IF VALUE=ICOMMA THEN @SETSEPARATOR
 IF VALUE=IDOT THEN SETEOL
 RETURN
.SETSEPARATOR
 SEPARATOR=TRUE
 GOTO SETEOL

.SETNOTHINGMORE
; There is no more input to come on this line
 NOMOREINPUT=TRUE
.SETEOL
 EOL=TRUE
 RETURN
;---
.GOBACK
; MARK CURRENT WORD AS UNPROCESSED, SO A SUBSEQUENT INPUT ROUTINE
; CAN GET A CHANCE AT READING IT
 INDEX=0
 GOSUB READINPUTLIST
 IF VALUE=0 THEN GOBACKRET
 WORDNOTPROCESSED=TRUE
.GOBACKRET
 RETURN
;---
.READINPUTLIST
 ; VALUE:=INPUT(INDEX) 16 BIT. X1,X2 corrupted
 VALUE=LINPUT(INDEX)
 IF VALUE<>1 THEN RILNOTNUMBER
 WORDTYPE=NUMBTYPE
 X1=INDEX
 ADD X1,C1
 VALUE=LINPUT(X1) ; returns low order of number
 RETURN

.RILNOTNUMBER
 WORDTYPE=VALUE
; STRIP OFF TOP DHREE ( WORDTYPE8) BITS
 X1=32
.RIL1
 IF VALUE<32 THEN RIL2
 SUB VALUE,X1
 GOTO RIL1
.RIL2
 GOSUB VALUETIMES256
 X1=1
 ADD X1,INDEX
 X2=LINPUT(X1)
 ADD VALUE,X2
; Suparate out WORDDYPE = top three0bits
 X2=WORDTYPE
 WORDTYPE=ASCITYPE
 X1=ASCIOFFSET
 IF X2<32 THEN RILRET
 WORDTYPE=VERBTYPE
 X1=VERBOFFSET
 IF X2<64 THEN RILRET
 WORDTYPE=CONJTYPE
 X1=CONJOFFSET
 IF X2<96 THEN RILRET
 WORDTYPE=PREPTYPE
 X1=PREPOFFSET
 IF X2<128 THEN RILRET
 WORDTYPE=NOUNTYPE
 X1=NOUNOFFSET
 IF X2<160 THEN RILRET
 WORDTYPE=ADJETYPE
 X1=ADJEOFFSET
 IF X2<192 THEN RILRET
 WORDTYPE=MATCHTYPE
 X1=MATCHOFFSET
 IF X2<224 THEN RILRET
 WORDTYPturn RESULT=TRUE if 'OBJECT' is
; at 'HIPOS','POS'
; if POS=0, it is treate as NONSPECIFIC
; likewise, HIPOS=NONSPECIFIC is handled
; return X4=lo position of object (or object if on ground)
 X4=OBJECT
.COP1
 IF POS=0 THEN COPHI
 X1=CURRENTPOS(X4)
 IF X1<>POS THEN COPNOTYET
.COPHI
; lo address is same, now check hi address
 X1=HICURRENTPOS(X4)
 IF X1=0 THEN COPHI1
 IF HIPOS=NONSPECIFIC THEN COPFOUND ; provided object is contained
.COPHI1
 IF X1<>HIPOS THEN COPNOTYET
.COPFOUND
 RESULT=TRUEturn RESULT=TRUE if 'OBJECT' is
; at 'HIPOS','POS'
; if POS=0, it is treate as NONSPECIFIC
; likewise, HIPOS=NONSPECIFIC is handled
; return X4=lo position of object (or object if on ground)
 X4=OBJECT
.COP1
 IF POS=0 THEN COPHI
 X1=CURRENTPOS(X4)
 IF X1<>POS THEN COPNOTYET
.COPHI
; lo address is same, now check hi address
 X1=HICURRENTPOS(X4)
 IF X1=0 THEN COPHI1
 IF HIPOS=NONSPECIFIC THEN COPFOUND ; provided object is contained
.COPHI1
 IF X1<>HIPOS THEN COPNOTYET
.COPFOUND
 RESULT=TRUE
 RETURN
.COPNOTFOUND
 RESULT=FALSE
 RETURN
;
.COPNOTYET
 X1=HICURRENTPOS(X4)
 IF X1=0 THEN COPNOTFOUND
 X4=CURRENTPOS(X4)
 GOTO COP1
;
;---
.CHECKIFPRESENT
; is OBJECT in same room as player ?
 SAVEHISEARCHPOS=HISEARCHPOS
 HISEARCHPOS=NONSPECIFIC
 GOSUB @CHECKIFACCESSIBLE
 HISEARCHPOS=SAVEHISEARCHPOS
 RETURN
;---
.HELLO
 MESSAGE 2175 ; hello to you
 RETURN
;---
.THINK
; just in here to show off.
; trap I THINK THEREFORE I AM
; and print a rude message if detected
 GOSUB @GETNEXTWORD
 SEARCHTYPE=CONJTYPE
 GOSUB @CHECKTYPE
 IF VALUE<>ITHEREFORE THEN @DONTUNDERSTAND
 MESSAGE 2080 ; do you ?
 GOTO @CANCELINPUT
;---
.WHY
 MESSAGE 2081 ; why not ?
 RETURN
;---
.YES
 MESSAGE 2082 ; you sound very positive
 RETURN
;---
.NO
 MESSAGE 2083 ; you sound negative
 RETURN
;-----------------
