;Parser for Triligy Conversions

;Copyright (C) 1987 Level 9 Computing

;B:ACORE.TXT
;
; .DESCOBJPARSEX1 moved to aspecial >>mike 14/7/87
;

VAR
 DESCRIPTIONMODE WHEELFOUND

BEGIN
 GOTO @STARTGAME
;---

.PRINTEXITS
; OWTYPE=OWEXITS
; +++++ MUSN'T RETURN FROM THIS ROUTINE +++++++
; (because it is called from the parser directly, not
;  in the normal way)

 if prep=0 then pe0
 PreventExits=true
 if prep<32000 then pe0a
 PreventExits=false
.pe0a
 gosub @done
 goto PeRet ; >>mike 17/2/88

.pe0
 GOSUB @SETUPROOM ;>>
 NUMEXITS=0
 DIR=1 ; current direction
 OUTPUTWORD=0 ;>>
.PELOOP
; PRINT AN EXIT (IF VISIBLE)
 FROM=ROOM
 GOSUB @CHECKEXIT
 WORD1=0
 WORD2=0
 WORD3=0
 WORD4=0
 IF EXITVISIBLE=FALSE THEN PENEXTDIR
 WORD1=VERBOFFSET ;> EXITDESCBASE
 ADD WORD1,DIR
; IF DOOR=0 THEN PENODOOR
; WORD2= ; base for door messages
; ADD WORD2,DOOROPEN
;.PENODOOR
 ADD NUMEXITS,C1
 IF NUMEXITS<>2 THEN PE2
 MESSAGE 3020 ; EXITS ARE
.PE2
; IF WORD2<>0 THEN PEDESC ; through a door, so don't describe destination
; WORD2=* ; to
; WORD3=SHORTROOMDESCS
; ADD WORD3,DEST

;.PEDESC
 GOSUB OUTWORD12 ;>> 34
.PENEXTDIR
 ADD DIR,C1
 IF DIR<NUMDIRECTIONS THEN PELOOP ;> 14
.PERET1
 IF NUMEXITS>1 THEN PERET2
 IF NUMEXITS=0 THEN PERET
 MESSAGE 3021 ; ONLY EXIT IS
.PERET2
 WORD1=0
 WORD2=0
 GOSUB @OUTWORD12
.PERET
 GOTO @RESETSTACK ;>> RETURN
;---
.OUTWORD12
 WORD3=0
 WORD4=0
.OUTWORD1234
; WE ARE OUTPUTING A LIST OF WORDS, SEPARATED BY COMMAS
; ETC. THIS ROUTINE TAKES A SERIES OF WORDS ONE AT A TIME
; AND OUTPUTS THEM. BEFORE CALLING, SET OUTPUTWORD=0
; AT THE END OF THE LIST, CALL THIS ROUTINE WITH PARSEX1=0 AND THE LIST
; WILL BE FINISHED OFF WITH A FULL STOP ETC.
 IF WORD1=0 THEN OWEND
; FIRST OR SECOND WORD - JUST ADD TO BUFFER
 PARSEX4=OUTPUTWORD
 VALUE=WORD1
 GOSUB WRITEOUTBUFFER
 VALUE=WORD2
 GOSUB WRITEOUTBUFFER
 VALUE=WORD3
 GOSUB WRITEOUTBUFFER
 VALUE=WORD4
 GOSUB WRITEOUTBUFFER
 OUTPUTWORD=PARSEX4
 IF OUTPUTWORD<>24 THEN OWRET
;
.OW1
; THIRD TO SUBSEQUENT WORDS - print out oldest word
; in buffer, and shift the other two down
 PARSEX4=0 ; index into OUTPUTBUFFER
 GOSUB OWPRINT
 PARSEX1=0
 PARSEX2=8
.OW2
 PARSEX3=OUTPUTBUFFER(PARSEX2)
 OUTPUTBUFFER(PARSEX1)=PARSEX3
 ADD PARSEX1,C1
 ADD PARSEX2,C1
 IF PARSEX1<16 THEN OW2
 MESSAGE COMMA
 OUTPUTWORD=16
.OWRET
 RETURN

.OWEND
; HAVE RECEIVED THE TERMINATOR
 IF OUTPUTWORD=0 THEN OWRET ; NO WORDS OUTPUT AT ALL
; THERE MUST BE AT LEAST ONE WORD REMAINING IN BUFFER - SO OUTPUT IT
 PARSEX4=0 ; index into OUTPUTBUFFER
 GOSUB OWPRINT
 IF OUTPUTWORD=8 THEN OWSTOP ; ONLY ONE WORD OUTPUT - SO THATS IT !
; MUST HAVE OUTPUTWORD=2, SO 2 OR MORE WORDS OUTPUT.
; THEREFORE WANT TO FINISH OFF WITH "AND"
 MESSAGE AND
 PARSEX4=8 ; index into OUTPUTBUFFER
 GOSUB OWPRINT
.OWSTOP
 OUTPUTWORD=0
 MESSAGE DOT
 RETURN
;---
.OWPRINT
; Print words by message number starting at outputbuffer(PARSEX4)
 PARSEX3=3 ; words to print
.OWPRINT1
 GOSUB READOUTBUFFER
 PARSEX1=VALUE
;> IF OWTYPE=OWOBJECTS THEN DESCANOBJPARSEX1
 MESSAGE VALUE
 SUB PARSEX3,C1
 IF PARSEX3<NEGATIVE THEN OWPRINT1
 RETURN
;
;---
.WRITEOUTBUFFER
; write 16 bit word VALUE to OUTPUTBUFFER at (PARSEX4)
; do 16 bit autoincrement after the write
; must preserve PARSEX3
 ADD PARSEX4,C1 ; write low byte first
 OUTPUTBUFFER(PARSEX4)=VALUE
 SUB PARSEX4,C1
 GOSUB @VALUEDIV256
 OUTPUTBUFFER(PARSEX4)=VALUE
 ADD PARSEX4,C2 ; skip on to next entry
 RETURN
;---
.READOUTBUFFER
; read 16 bit word VALUE from OUTPUTBUFFER(PARSEXATUS
 IF PARSEX1<4 THEN CE2
 DOOR=TRUE
;> CURRENTPOS(GENERALDOOR)=ROOM
 SUB PARSEX1,C4
.CE2
 IF PARSEX1>1 THEN CERET
 EXITVISIBLE=TRUE
.CERET
 RETURN

;;---
.CRVARYMESSAGE
 MESSAGE CR
.VARYMESSAGE
;; OUTPUT ONE OF THREE MESSAGES AT 'PARSEM1'
;; GOSUB RAND3
;; ADD PARSEM1,NUMBER
; MESSAGE PARSEM1
; RETURN
 ADD CURRENTMESSAGE,C1
 IF CURRENTMESSAGE<3 THEN VMOK
 CURRENTMESSAGE=0
.VMOK
 PARSEX1=PARSEM1
 ADD PARSEX1,CURRENTMESSAGE
 MESSAGE PARSEX1
 RETURN
;---
ееееееееееееееееееееееееATUS
 IF PARSEX1<4 THEN CE2
 DOOR=TRUE
;> CURRENTPOS(GENERALDOOR)=ROOM
 SUB PARSEX1,C4
.CE2
 IF PARSEX1>1 THEN CERET
 EXITVISIBLE=TRUE
.CERET
 RETURN

;;---
.CRVARYMESSAGE
 MESSAGE CR
.VARYMESSAGE
;; OUTPUT ONE OF THREE MESSAGES AT 'PARSEM1'
;; GOSUB RAND3
;; ADD PARSEM1,NUMBER
; MESSAGE PARSEM1
; RETURN
 ADD CURRENTMESSAGE,C1
 IF CURRENTMESSAGE<3 THEN VMOK
 CURRENTMESSAGE=0
.VMOK
 PARSEX1=PARSEM1
 ADD PARSEX1,CURRENTMESSAGE
 MESSAGE PARSEX1
 RETURN
;---
